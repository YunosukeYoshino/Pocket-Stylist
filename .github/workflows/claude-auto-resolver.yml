name: Auto Issue Resolver

on:
  schedule:
    # JST 03:00-09:00ã®é–“ã€30åˆ†ã”ã¨ã«å®Ÿè¡Œ
    # JST = UTC + 9æ™‚é–“
    # JST 03:00 = UTC 18:00, JST 09:00 = UTC 00:00
    - cron: "0,30 18-23 * * *" # UTC 18:00-23:30 (JST 03:00-08:30)
    - cron: "0 0 * * *" # UTC 00:00 (JST 09:00)
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
permissions:
  issues: write
  contents: read
jobs:
  process-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Personal Access Token
        run: |
          if [ -z "${{ secrets.PERSONAL_ACCESS_TOKEN }}" ]; then
            echo "âŒ PERSONAL_ACCESS_TOKEN is not set. This workflow requires a Personal Access Token to post comments as a user account."
            echo "Please set PERSONAL_ACCESS_TOKEN in repository secrets."
            exit 1
          fi
          echo "âœ… Personal Access Token is available"

      - name: Find and process highest priority issue
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          set -e  # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼ã§åœæ­¢

          # å„ªå…ˆåº¦é †ã«issueã‚’æ¢ã™
          priorities=("high" "middle" "low")
          processed_label="claude-code-requested"

          for priority in "${priorities[@]}"; do
            echo "ğŸ” Processing priority: $priority"

            # å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸissueã‚’å–å¾—ï¼ˆä½œæˆæ—¥æ™‚ã®é™é †ï¼‰
            echo "Fetching issues with label '$priority'..."
            issues=$(gh issue list --label "$priority" --state open --json number,title,body,labels --limit 100)

            if [ "$issues" = "[]" ]; then
              echo "No issues found for priority: $priority"
              continue
            fi

            # æœªå‡¦ç†ã®issueã‚’æ¢ã™
            unprocessed_issue=$(echo "$issues" | jq -r --arg processed_label "$processed_label" '
              .[] | select(.labels | map(.name) | contains([$processed_label]) | not) | .number
            ' | head -1)

            if [ "$unprocessed_issue" != "" ] && [ "$unprocessed_issue" != "null" ]; then
              echo "âœ… Found unprocessed issue: #$unprocessed_issue"

              # Issueæƒ…å ±ã‚’å–å¾—
              issue_info=$(echo "$issues" | jq -r --arg number "$unprocessed_issue" '.[] | select(.number == ($number | tonumber))')
              issue_title=$(echo "$issue_info" | jq -r '.title')
              issue_body=$(echo "$issue_info" | jq -r '.body // "èª¬æ˜ãªã—"')

              # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
              comment_text="@claude ã“ã®Issue #${unprocessed_issue} ã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚"
              comment_text="$comment_text

              ä»¥ä¸‹ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€å…·ä½“çš„ãªå®Ÿè£…æ–¹é‡ã¨å¿…è¦ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š

              ã‚¿ã‚¤ãƒˆãƒ«: ${issue_title}

              èª¬æ˜:
              ${issue_body}

              å„ªå…ˆåº¦: ${priority}"

              echo "ğŸ“ Posting comment to issue #$unprocessed_issue"
              gh issue comment "$unprocessed_issue" --body "$comment_text"

              # å‡¦ç†æ¸ˆã¿ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              echo "ğŸ·ï¸ Adding processed label to issue #$unprocessed_issue"
              gh issue edit "$unprocessed_issue" --add-label "$processed_label"

              echo "ğŸš€ Claude Code Action will be triggered by the mention"

              exit 0  # 1ã¤ã®issueã®ã¿å‡¦ç†ã—ã¦çµ‚äº†
            else
              echo "No unprocessed issues found for priority: $priority"
            fi
          done

          echo "â„¹ï¸ No unprocessed issues found across all priorities"

# ... (çœç•¥)
